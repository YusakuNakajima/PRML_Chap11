---
marp: true
theme: default
paginate: true
---

# 後半目次

## 11.2 マルコフ連鎖モンテカルロ(MCMC)
- 11.2.1 マルコフ連鎖とメトロポリス法
- 11.2.2 メトロポリス・ヘイスティング法

## 11.3 ギブスサンプリング

## 11.4 スライスサンプリング

## 11.5 ハイブリッドモンテカルロ(統計力学との融合)
- 11.5.1 力学系
- 11.5.2 ハイブリッドモンテカルロ

## 11.6 分配関数の推定
---

# 11.2 マルコフ連鎖モンテカルロ

前のセクションでは、関数の期待値を評価するための棄却サンプリングと重点サンプリングの戦略について議論し、それらが特に高次元空間で深刻な制限を受けることを見た
このセクションでは、マルコフ連鎖モンテカルロ（MCMC）と呼ばれる非常に一般的で強力なフレームワークに目を向ける
MCMCは、多くの分布からサンプリングを可能にし、サンプル空間の次元に対してスケールが良い
MCMC法は物理学に起源を持ち（Metropolis and Ulam, 1949）、1980年代の終わり頃に統計学の分野で大きな影響を与え始めた

---

## 提案分布からのサンプリング

棄却サンプリングや重点サンプリングと同様に、提案分布からサンプリングする
今回は、現在の状態 $z^{(\tau)}$ を記録し、提案分布 $q(z|z^{(\tau)})$ はこの現在の状態に依存する
したがって、サンプルのシーケンス $z^{(1)}, z^{(2)}, \ldots$ はマルコフ連鎖を形成する
$p(z) = \tilde{p}(z)/Z_p$ と書くと、$\tilde{p}(z)$ は任意の $z$ の値に対して容易に評価できると仮定するが、$Z_p$ の値は未知であるかもしれない
提案分布自体は、直接サンプルを生成するのが簡単なように選ばれる
アルゴリズムの各サイクルで、提案分布から候補サンプル $z^*$ を生成し、適切な基準に従ってサンプルを受け入れる

---

## メトロポリスアルゴリズム

基本的なメトロポリスアルゴリズム（Metropolis et al., 1953）では、提案分布が対称であると仮定する
すなわち、すべての $z_A$ と $z_B$ の値に対して $q(z_A|z_B) = q(z_B|z_A)$ である
候補サンプルは次の確率で受け入れられる

$$
A(z^*, z^{(\tau)}) = \min \left(1, \frac{\tilde{p}(z^*)}{\tilde{p}(z^{(\tau)})} \right)
$$

これは、単位区間 $(0, 1)$ に均一に分布する乱数 $u$ を選び、$A(z^*, z^{(\tau)}) > u$ の場合にサンプルを受け入れることで達成される
$z^{(\tau)}$ から $z^*$ へのステップが $p(z)$ の値を増加させる場合、候補点は確実に保持される

---

## サンプルの受け入れと拒否

候補サンプルが受け入れられた場合、$z^{(\tau+1)} = z^*$ となる
そうでない場合、候補点 $z^*$ は破棄され、$z^{(\tau+1)}$ は $z^{(\tau)}$ に設定され、提案分布 $q(z|z^{(\tau+1)})$ から別の候補サンプルが生成される
これは、棄却サンプリングとは対照的であり、棄却されたサンプルは単に破棄される
メトロポリスアルゴリズムでは、候補点が拒否された場合、前のサンプルが最終サンプルリストに含まれるため、サンプルの複数のコピーが生成される
実際の実装では、各保持されたサンプルの単一コピーのみが保持され、その状態が何回出現するかを記録する整数重み付け係数が保持される

---

## マルコフ連鎖の収束

$q(z_A|z_B)$ が任意の $z_A$ と $z_B$ の値に対して正である限り（これは十分条件であるが必要条件ではない）、$z^{(\tau)}$ の分布は $\tau \to \infty$ として $p(z)$ に収束する
ただし、シーケンス $z^{(1)}, z^{(2)}, \ldots$ は $p(z)$ からの独立したサンプルセットではないことを強調する必要がある
連続するサンプルは高度に相関しているためである
独立したサンプルを取得したい場合、シーケンスのほとんどを破棄し、$M$ 番目ごとのサンプルのみを保持することができる
$M$ が十分に大きい場合、保持されたサンプルは実質的に独立している

---

## 図: メトロポリスアルゴリズムによるサンプリング

![Metropolis Algorithm](path_to_your_image.png)

---

## ランダムウォークの例

マルコフ連鎖モンテカルロアルゴリズムの性質をさらに理解するために、単純なランダムウォークの例を考える
状態空間 $z$ が整数で構成され、確率が次のように与えられる場合を考える

$$
p(z^{(\tau+1)} = z^{(\tau)}) = 0.5
$$

$$
p(z^{(\tau+1)} = z^{(\tau)} + 1) = 0.25
$$

$$
p(z^{(\tau+1)} = z^{(\tau)} - 1) = 0.25
$$

初期状態が $z^{(1)} = 0$ である場合、対称性により時間 $\tau$ の期待状態もゼロ $E[z^{(\tau)}] = 0$ となる
同様に、$E[(z^{(\tau)})^2] = \tau /2$ であることが容易にわかる
したがって、$\tau$ ステップ後、ランダムウォークは平均して $\tau$ の平方根に比例する距離しか移動していない
この平方根依存性はランダムウォークの典型的な挙動であり、状態空間の探索において非常に非効率であることを示している
マルコフ連鎖モンテカルロ法の設計における中心的な目標は、ランダムウォークの挙動を回避することである

---

# 11.2.1 マルコフ連鎖

マルコフ連鎖モンテカルロ法を詳しく説明する前に、マルコフ連鎖の一般的な性質を詳しく学ぶことが有用である
特に、マルコフ連鎖がどのような条件下で目的の分布に収束するかを考える
一次マルコフ連鎖は、次の条件付き独立性の性質を満たす一連のランダム変数 $z^{(1)}, \ldots, z^{(M)}$ と定義される

$$
p(z^{(m+1)}|z^{(1)}, \ldots, z^{(m)}) = p(z^{(m+1)}|z^{(m)}) \quad \text{for} \quad m \in \{1, \ldots, M - 1\}
$$

これは、図8.38に示されているように、連鎖の形で有向グラフとして表現できる
次に、初期変数の確率分布 $p(z^{(0)})$ と遷移確率 $T_m(z^{(m)}, z^{(m+1)}) \equiv p(z^{(m+1)}|z^{(m)})$ の形でマルコフ連鎖を指定できる
マルコフ連鎖が均質であると言われるのは、すべての $m$ に対して遷移確率が同じ場合である

---

## 周辺確率の表現

特定の変数の周辺確率は、連鎖内の前の変数の周辺確率の形で表現できる

$$
p(z^{(m+1)}) = \sum_{z^{(m)}} p(z^{(m+1)}|z^{(m)}) p(z^{(m)})
$$

---

## 不変分布

分布がマルコフ連鎖に対して不変（または定常）であると言われるのは、連鎖の各ステップがその分布を不変にする場合である
したがって、遷移確率 $T(z', z)$ を持つ均質マルコフ連鎖に対して、分布 $p(z)$ が不変であるのは次の場合である

$$
p(z) = \sum_{z'} T(z', z) p(z')
$$

---

## 詳細釣り合い

特定の分布 $p(z)$ に対して、遷移確率が詳細釣り合いの性質を満たすように選択することが、不変分布を保証するための十分条件である

$$
p(z) T(z, z') = p(z') T(z', z)
$$

詳細釣り合いを満たす遷移確率は、その分布を不変にする

---

## エルゴード性

マルコフ連鎖を使用して特定の分布からサンプリングすることが目標である
これを達成するには、目的の分布が不変であるようにマルコフ連鎖を設定する必要がある
さらに、$m \to \infty$ の場合、分布 $p(z^{(m)})$ が初期分布 $p(z^{(0)})$ に関係なく目的の不変分布 $p(z)$ に収束する必要がある
この性質はエルゴード性と呼ばれ、不変分布は平衡分布と呼ばれる
エルゴード性を持つマルコフ連鎖は、平衡分布を1つしか持たない

---

## 遷移確率の構築

実際には、遷移確率を一連の基本遷移 $B_1, \ldots, B_K$ から構築することが多い
これは、次の形の混合分布を通じて達成できる

$$
T(z', z) = \sum_{k=1}^{K} \alpha_k B_k(z', z)
$$

ここで、混合係数 $\alpha_1, \ldots, \alpha_K$ は $\alpha_k \geq 0$ かつ $\sum_{k} \alpha_k = 1$ を満たす
または、基本遷移を連続して適用することで組み合わせることもできる

$$
T(z', z) = \sum_{z_1} \ldots \sum_{z_{n-1}} B_1(z', z_1) \ldots B_{K-1}(z_{K-2}, z_{K-1}) B_K(z_{K-1}, z)
$$

---

## 詳細釣り合いの復元

混合遷移（11.42）の場合、各基本遷移が詳細釣り合いを満たす場合、混合遷移 $T$ も詳細釣り合いを満たす
ただし、（11.43）を使用して構築された遷移確率には当てはまらないが、基本遷移の適用順序を対称化することで詳細釣り合いを復元できる
例えば、$B_1, B_2, \ldots, B_K, B_K, \ldots, B_2, B_1$ の形である
複合遷移確率の一般的な例は、各基本遷移が変数のサブセットのみを変更する場合である

---

# 11.2.2 メトロポリス・ヘイスティングスアルゴリズム

前に基本的なメトロポリスアルゴリズムを紹介したが、それが必要な分布からサンプリングすることを実証していなかった
証明を行う前に、提案分布が引数の対称関数ではない場合の一般化であるメトロポリス・ヘイスティングスアルゴリズム（Hastings, 1970）について説明する
特に、アルゴリズムのステップ $\tau$ で、現在の状態が $z^{(\tau)}$ の場合、分布 $q_k(z|z^{(\tau)})$ からサンプル $z^*$ を生成し、次の確率 $A_k(z^*, z^{(\tau)})$ で受け入れる

$$
A_k(z^*, z^{(\tau)}) = \min \left(1, \frac{\tilde{p}(z^*) q_k(z^{(\tau)}|z^*)}{\tilde{p}(z^{(\tau)}) q_k(z^*|z^{(\tau)})} \right)
$$

ここで、$k$ は考慮される遷移のセットのメンバーをラベル付けする
受け入れ基準の評価には、確率分布 $p(z) = \tilde{p}(z)/Z_p$ の正規化定数 $Z_p$ の知識は必要ない
対称提案分布の場合、メトロポリス・ヘイスティングス基準（11.44）は標準メトロポリス基準（11.33）に帰着する

---

## 不変分布の証明

メトロポリス・ヘイスティングスアルゴリズムによって定義されるマルコフ連鎖の不変分布が $p(z)$ であることを示すために、詳細釣り合い（11.40）が満たされることを示す
（11.44）を使用すると次のようになる

$$
p(z) q_k(z|z') A_k(z', z) = \min (p(z) q_k(z|z'), p(z') q_k(z'|z)) = \min (p(z') q_k(z'|z), p(z) q_k(z|z')) = p(z') q_k(z'|z) A_k(z, z')
$$

---

## 提案分布の選択

提案分布の具体的な選択は、アルゴリズムの性能に大きな影響を与える
連続状態空間の場合、一般的な選択は現在の状態を中心としたガウス分布であり、この分布の分散パラメータを決定する際の重要なトレードオフがある
分散が小さい場合、受け入れられる遷移の割合は高くなるが、状態空間の探索は遅いランダムウォークの形を取り、長い相関時間をもたらす
しかし、分散パラメータが大きい場合、提案されたステップの多くが低確率の状態に対するものであるため、棄却率が高くなる

---

## 図: メトロポリス・ヘイスティングスアルゴリズムによるサンプリング

![Metropolis-Hastings Algorithm](path_to_your_image.png)

---

## 提案分布のスケール

多変量分布 $p(z)$ が $z$ の成分間に強い相関を持つ場合、提案分布のスケール $\rho$ は棄却率を高くしないようにできるだけ大きくする必要がある
これは、$\rho$ が最小の長さスケール $\sigma_{\min}$ と同程度であるべきことを示唆している
システムは、より拡張された方向に沿ってランダムウォークによって分布を探索し、元の状態からほぼ独立した状態に到達するために必要なステップ数は $\sigma_{\max}/\sigma_{\min}$ の2乗のオーダーである

---

## 提案分布の影響

2次元では、$\rho$ が増加するにつれて棄却率の増加は、受け入れられた遷移のステップサイズの増加によって相殺される
一般に、多変量ガウス分布の場合、独立したサンプルを取得するために必要なステップ数は $\sigma_{\max}/\sigma_2$ の2乗のオーダーでスケールする
ここで、$\sigma_2$ は2番目に小さい標準偏差である
これらの詳細はさておき、分布が異なる方向で非常に異なる長さスケールを持つ場合、メトロポリス・ヘイスティングスアルゴリズムは非常に遅い収束を示すことがある

---

# 11.3 ギブスサンプリング

ギブスサンプリング（Geman and Geman, 1984）は、シンプルで広く適用可能なマルコフ連鎖モンテカルロアルゴリズムであり、メトロポリス・ヘイスティングスアルゴリズムの特別なケースと見なすことができる
分布 $p(z) = p(z_1, \ldots, z_M)$ からサンプリングしたいと考え、マルコフ連鎖の初期状態を選択したとする
ギブスサンプリング手順の各ステップでは、変数の1つの値を、他の変数の値に条件付けられたその変数の分布から取得した値に置き換える
したがって、$z_i$ を $p(z_i|z_{\setminus i})$ の分布から取得した値に置き換える
ここで、$z_i$ は $z$ の $i$ 番目の成分を示し、$z_{\setminus i}$ は $z_1, \ldots, z_M$ から $z_i$ を除いたものである

---

## ギブスサンプリングの手順

例えば、3つの変数 $z_1, z_2, z_3$ の分布 $p(z_1, z_2, z_3)$ を考え、アルゴリズムのステップ $\tau$ で値 $z_1^{(\tau)}, z_2^{(\tau)}, z_3^{(\tau)}$ を選択したとする
まず、$z_1^{(\tau)}$ を条件付き分布 $p(z_1|z_2^{(\tau)}, z_3^{(\tau)})$ からサンプリングして新しい値 $z_1^{(\tau+1)}$ に置き換える

$$
p(z_1|z_2^{(\tau)}, z_3^{(\tau)})
$$

次に、$z_2^{(\tau)}$ を条件付き分布 $p(z_2|z_1^{(\tau+1)}, z_3^{(\tau)})$ からサンプリングして新しい値 $z_2^{(\tau+1)}$ に置き換える

$$
p(z_2|z_1^{(\tau+1)}, z_3^{(\tau)})
$$

その後、$z_3$ を条件付き分布 $p(z_3|z_1^{(\tau+1)}, z_2^{(\tau+1)})$ からサンプリングして新しい値 $z_3^{(\tau+1)}$ に置き換える

$$
p(z_3|z_1^{(\tau+1)}, z_2^{(\tau+1)})
$$

---

## ギブスサンプリングのアルゴリズム

1. 初期化 $\{z_i : i = 1, \ldots, M\}$
2. $\tau = 1, \ldots, T$ に対して:
   - $z_1^{(\tau+1)} \sim p(z_1|z_2^{(\tau)}, z_3^{(\tau)}, \ldots, z_M^{(\tau)})$
   - $z_2^{(\tau+1)} \sim p(z_2|z_1^{(\tau+1)}, z_3^{(\tau)}, \ldots, z_M^{(\tau)})$
   - ...
   - $z_j^{(\tau+1)} \sim p(z_j|z_1^{(\tau+1)}, \ldots, z_{j-1}^{(\tau+1)}, z_{j+1}^{(\tau)}, \ldots, z_M^{(\tau)})$
   - ...
   - $z_M^{(\tau+1)} \sim p(z_M|z_1^{(\tau+1)}, z_2^{(\tau+1)}, \ldots, z_{M-1}^{(\tau+1)})$

---

## 不変分布の証明

この手順が必要な分布からサンプリングすることを示すために、まず分布 $p(z)$ がギブスサンプリングの各ステップ個別に不変であり、したがってマルコフ連鎖全体に対して不変であることを確認する
これは、$p(z_i|z_{\setminus i})$ からサンプリングする場合、周辺分布 $p(z_{\setminus i})$ が不変であるためである
また、各ステップは定義により正しい条件付き分布 $p(z_i|z_{\setminus i})$ からサンプリングする
これらの条件付き分布と周辺分布が共同分布を指定するため、共同分布自体が不変であることがわかる

---

## エルゴード性の条件

ギブスサンプリング手順が正しい分布からサンプリングするための2番目の要件は、エルゴード性である
エルゴード性の十分条件は、条件付き分布がどこでもゼロでないことである
この場合、$z$ 空間の任意の点は、各成分変数の1回の更新を含む有限のステップ数で他の任意の点に到達できる
この要件が満たされない場合、すなわち条件付き分布にゼロが含まれる場合、エルゴード性が適用される場合は明示的に証明する必要がある

---

## 初期状態とサンプルの相関

アルゴリズムを完了するためには、初期状態の分布も指定する必要があるが、多くの反復後に取得されたサンプルはこの分布から実質的に独立になる
もちろん、マルコフ連鎖からの連続サンプルは高度に相関しているため、ほぼ独立したサンプルを取得するにはシーケンスをサブサンプリングする必要がある

---

## メトロポリス・ヘイスティングスアルゴリズムとの関係

ギブスサンプリング手順は、メトロポリス・ヘイスティングスアルゴリズムの特定のインスタンスとして取得できる
変数 $z_k$ に関するメトロポリス・ヘイスティングスサンプリングステップを考え、残りの変数 $z_{\setminus k}$ は固定される
遷移確率が $q_k(z^*|z) = p(z_k^*|z_{\setminus k})$ で与えられる場合、受け入れ確率は常に1であるため、メトロポリス・ヘイスティングスステップは常に受け入れられる

---

## 図: ギブスサンプリングの例

![Gibbs Sampling](path_to_your_image.png)

---

## ランダムウォークの削減

ギブスサンプリングのランダムウォーク挙動を減らすためのアプローチとして、オーバーリラクゼーション（Adler, 1981）がある
これは、条件付き分布がガウス分布である問題に適用される
オーバーリラクゼーションの効果は、変数が高度に相関している場合に状態空間を通じて指向性の動きを促進することである

---

## グラフィカルモデルでの適用

ギブスサンプリングの実用性は、条件付き分布 $p(z_k|z_{\setminus k})$ からサンプルを取得する容易さに依存する
グラフィカルモデルを使用して指定された確率分布の場合、条件付き分布は対応するマルコフブランケット内の変数のみに依存する
適応的棄却サンプリング法は、広範な適用性を持つモンテカルロサンプリングのフレームワークを提供する

---

# 11.4 スライスサンプリング

メトロポリスアルゴリズムの難点の一つはステップサイズに対する感度である
ステップサイズが小さすぎるとランダムウォークの挙動によりデコリレーションが遅くなり、ステップサイズが大きすぎると高い棄却率により効率が低下する
スライスサンプリング（Neal, 2003）は、分布の特性に合わせて自動的に調整される適応的なステップサイズを提供する
ここでも、未正規化分布 $\tilde{p}(z)$ を評価できる必要がある

---

## 一変量の場合

まず一変量の場合を考える
スライスサンプリングでは、$z$ に追加の変数 $u$ を加え、$(z, u)$ 空間からサンプルを取得する
このアプローチの別の例は、セクション11.5でハイブリッドモンテカルロを議論する際に見ることになる
目標は、分布の下の領域から均一にサンプリングすることである

---

## 図: スライスサンプリングの例

![Slice Sampling](path_to_your_image.png)

---

## スライスサンプリングの手順

1. 現在の値 $z^{(\tau)}$ に対して、$u$ の値を $0 \leq u \leq \tilde{p}(z^{(\tau)})$ の範囲で均一に選択する
2. この $u$ の値に対して、分布を通る「スライス」を定義する
3. スライスから直接サンプリングするのが難しいため、$z^{(\tau)}$ を含む領域 $z_{\min} \leq z \leq z_{\max}$ を考える
4. この領域の選択により、分布の特性長さスケールに適応する
5. 領域の端点がスライス内にあるかどうかを確認し、スライス外にある場合は領域を拡張する
6. 領域から候補値 $z^*$ を均一に選択し、スライス内にある場合は $z^{(\tau+1)}$ とする
7. スライス外にある場合、領域を縮小し、$z^*$ を端点として再度候補点を選択する

---

## 多変量分布への適用

スライスサンプリングは、ギブスサンプリングの方法で各変数を順番にサンプリングすることで多変量分布に適用できる
これには、各成分 $z_i$ に対して $p(z_i|z_{\setminus i})$ に比例する関数を計算できる必要がある

---

# 11.5 ハイブリッドモンテカルロアルゴリズム

メトロポリスアルゴリズムの主要な制限の一つは、ランダムウォークの挙動を示すことであり、状態空間を通る距離がステップ数の平方根としてしか成長しないことである
この問題は、ステップを大きくすることで解決できない。なぜなら、これにより棄却率が高くなるからである
このセクションでは、物理システムとの類推に基づく、より洗練された遷移クラスを紹介する
このクラスは、システム状態に大きな変化をもたらしながら、棄却確率を小さく保つ特性を持つ
状態変数に対する対数確率の勾配を容易に評価できる連続変数の分布に適用可能である

---

## 力学系のフレームワーク

セクション11.5.1では、力学系のフレームワークについて議論する
このフレームワークをメトロポリスアルゴリズムと組み合わせることで、強力なハイブリッドモンテカルロアルゴリズムを導出する方法を説明する
物理学の背景は必要なく、このセクションは自己完結しており、主要な結果はすべて基本原理から導出される

---

## メトロポリスアルゴリズムとの組み合わせ

セクション11.5.2では、力学系のフレームワークをメトロポリスアルゴリズムと組み合わせる方法を説明する
これにより、ハイブリッドモンテカルロアルゴリズムが得られる
このアルゴリズムは、システム状態に大きな変化をもたらしながら、棄却確率を小さく保つ特性を持つ

---

## ハイブリッドモンテカルロの利点

ハイブリッドモンテカルロアルゴリズムは、連続変数の分布に適用可能であり、状態変数に対する対数確率の勾配を容易に評価できる
これにより、メトロポリスアルゴリズムのランダムウォークの問題を克服し、効率的なサンプリングを実現する

---

# 11.5.1 力学系

確率的サンプリングへの力学的アプローチは、ハミルトン力学の下で進化する物理システムのシミュレーションアルゴリズムに起源を持つ
マルコフ連鎖モンテカルロシミュレーションでは、特定の確率分布 $p(z)$ からサンプリングすることが目標である
ハミルトン力学のフレームワークを利用して、確率シミュレーションをハミルトン系の形式にキャストする

---

## 状態変数の進化

考慮する力学は、連続時間 $\tau$ の下で状態変数 $z = \{z_i\}$ の進化に対応する
古典力学は、物体の加速度が作用する力に比例するというニュートンの第二法則によって記述され、時間に関する二階微分方程式に対応する
中間の運動量変数 $r$ を導入することで、二階方程式を二つの連立一次方程式に分解できる

$$
r_i = \frac{dz_i}{d\tau}
$$

---

## ハミルトン力学のフレームワーク

確率分布 $p(z)$ を次の形式で書くことができる

$$
p(z) = \frac{1}{Z_p} \exp(-E(z))
$$

ここで、$E(z)$ は状態 $z$ におけるポテンシャルエネルギーとして解釈される
システムの加速度は運動量の変化率であり、作用する力によって与えられる

$$
\frac{dr_i}{d\tau} = -\frac{\partial E(z)}{\partial z_i}
$$

---

## ハミルトン関数

運動エネルギーを次のように定義する

$$
K(r) = \frac{1}{2} \sum_i r_i^2
$$

システムの全エネルギーはポテンシャルエネルギーと運動エネルギーの和である

$$
H(z, r) = E(z) + K(r)
$$

---

## ハミルトン方程式

システムの動力学を次のハミルトン方程式で表現できる

$$
\frac{dz_i}{d\tau} = \frac{\partial H}{\partial r_i}
$$

$$
\frac{dr_i}{d\tau} = -\frac{\partial H}{\partial z_i}
$$

---

## ハミルトン力学の特性

ハミルトン力学系の重要な特性の一つは、ハミルトン関数 $H$ の値が一定であることである

$$
\frac{dH}{d\tau} = 0
$$

もう一つの重要な特性は、位相空間の体積を保存することである（リウヴィルの定理）

---

## 位相空間の保存

位相空間の流れ場は次のように与えられる

$$
V = \left( \frac{dz}{d\tau}, \frac{dr}{d\tau} \right)
$$

この場の発散はゼロである

$$
\text{div} V = 0
$$

---

## ハミルトン力学の応用

ハミルトン力学の下での進化は、ランダムウォークの挙動を回避しながら $z$ に大きな変化をもたらすことができる
エルゴード性を達成するために、ハミルトン関数 $H$ の値を変える追加の移動を導入できる
最も簡単な方法は、$r$ の値を $z$ に条件付けられた分布から再サンプリングすることである

---

## 数値積分の問題

ハミルトン方程式の数値積分を行う際には、数値誤差が発生する
リウヴィルの定理が正確に成り立つ積分スキームを設計することが重要である
一つの方法はリープフロッグ離散化であり、位置変数と運動量変数を交互に更新する

---

## リープフロッグ離散化

$$
r_i(\tau + \epsilon/2) = r_i(\tau) - \frac{\epsilon}{2} \frac{\partial E}{\partial z_i}(z(\tau))
$$

$$
z_i(\tau + \epsilon) = z_i(\tau) + \epsilon r_i(\tau + \epsilon/2)
$$

$$
r_i(\tau + \epsilon) = r_i(\tau + \epsilon/2) - \frac{\epsilon}{2} \frac{\partial E}{\partial z_i}(z(\tau + \epsilon))
$$

---

## ハイブリッドモンテカルロアルゴリズム

ハミルトン力学的アプローチは、リープフロッグ更新と運動量変数の再サンプリングを交互に行う
これにより、対数確率分布の勾配情報を利用して効率的なサンプリングを実現する

---

# 11.5.2 ハイブリッドモンテカルロ

前のセクションで議論したように、非ゼロのステップサイズ $\epsilon$ の場合、リープフロッグアルゴリズムの離散化はハミルトン力学方程式の積分に誤差を導入する
ハイブリッドモンテカルロ（Duane et al., 1987; Neal, 1996）は、ハミルトン力学とメトロポリスアルゴリズムを組み合わせることで、この離散化に関連するバイアスを除去する

---

## アルゴリズムの概要

具体的には、アルゴリズムは運動量変数 $r$ の確率的更新とリープフロッグアルゴリズムを使用したハミルトン力学的更新を交互に行うマルコフ連鎖を使用する
リープフロッグアルゴリズムの各適用後、得られた候補状態はハミルトン関数 $H$ の値に基づいてメトロポリス基準に従って受け入れまたは棄却される
したがって、$(z, r)$ が初期状態で $(z^*, r^*)$ がリープフロッグ積分後の状態である場合、この候補状態は次の確率で受け入れられる

$$
\min \left(1, \exp\{H(z, r) - H(z^*, r^*)\} \right)
$$

---

## メトロポリス基準の適用

リープフロッグ積分がハミルトン力学を完全にシミュレートする場合、すべての候補ステップは自動的に受け入れられる
数値誤差により、$H$ の値が時々減少することがあり、この効果によるバイアスを除去し、結果として得られるサンプルが必要な分布から取得されることを保証するためにメトロポリス基準を適用する

---

## 詳細釣り合いの確保

リープフロッグ積分が詳細釣り合いを満たすことを確認するために、各リープフロッグ積分シーケンスの開始前に、時間を前進（ステップサイズ $\epsilon$ を使用）または後退（ステップサイズ $-\epsilon$ を使用）するかをランダムに選択する
リープフロッグ積分スキームは時間反転可能であり、ステップサイズ $-\epsilon$ を使用して $L$ ステップ積分することは、ステップサイズ $\epsilon$ を使用して $L$ ステップ積分する効果を正確に打ち消す

---

## 位相空間の体積保存

リープフロッグ積分は位相空間の体積を正確に保存する
これは、リープフロッグスキームの各ステップが $z_i$ 変数または $r_i$ 変数のいずれかを他の変数の関数として更新することによる

---

## 図: 位相空間の体積保存

![Phase Space Volume Preservation](path_to_your_image.png)

---

## 詳細釣り合いの証明

小さな位相空間領域 $R$ を考え、ステップサイズ $\epsilon$ の $L$ リープフロッグ反復のシーケンスの下で $R$ が領域 $R^*$ にマッピングされるとする
リープフロッグ反復の下での体積保存を使用すると、$R$ の体積が $\delta V$ である場合、$R^*$ も同様に $\delta V$ の体積を持つ
初期点を分布（11.63）から選択し、$L$ リープフロッグ反復を使用して更新すると、遷移確率は次のように与えられる

$$
\frac{1}{Z_H} \exp(-H(R)) \delta V \frac{1}{2} \min \{1, \exp(-H(R) + H(R^*))\}
$$

ここで、1/2 の因子は正のステップサイズを選択する確率から生じる

---

# 11.6 分配関数の推定

これまでに考察したほとんどのサンプリングアルゴリズムは、確率分布の関数形が乗法定数までわかれば十分である
したがって、次のように書くと

$$
p_E(z) = \frac{1}{Z_E} \exp(-E(z))
$$

正規化定数 $Z_E$（分配関数とも呼ばれる）の値は、$p(z)$ からサンプルを取得するためには必要ない
しかし、$Z_E$ の値を知ることはベイズモデル比較に有用であり、モデル証拠を表すため、その値を取得する方法を考察する

---

## 分配関数の比の推定

モデル比較のためには、実際には2つのモデルの分配関数の比が必要である
この比に事前確率の比を掛けることで、事後確率の比が得られ、モデル選択やモデル平均化に使用できる

---

## 重要度サンプリングによる推定

エネルギー関数 $G(z)$ を持つ分布からの重要度サンプリングを使用して、分配関数の比を推定する方法

$$
\frac{Z_E}{Z_G} = \frac{\sum_z \exp(-E(z))}{\sum_z \exp(-G(z))} = \frac{\sum_z \exp(-E(z) + G(z)) \exp(-G(z))}{\sum_z \exp(-G(z))} = E_{G(z)}[\exp(-E + G)] \approx \sum_l \exp(-E(z^{(l)}) + G(z^{(l)}))
$$

ここで、$\{z^{(l)}\}$ は $p_G(z)$ によって定義される分布から取得されたサンプルである

---

## マルコフ連鎖を使用した推定

マルコフ連鎖から取得されたサンプルを使用して重要度サンプリング分布を定義する方法

$$
\frac{1}{Z_G} \exp(-G(z)) = \sum_{l=1}^{L} T(z^{(l)}, z)
$$

これを直接（11.72）に使用できる

---

## チェイニング技法

複雑な分布の絶対値を見つけるための問題を解決するために、チェイニング技法を使用する
これは、単純な分布 $p_1(z)$ から目的の複雑な分布 $p_M(z)$ までの中間分布 $p_2, \ldots, p_{M-1}$ を導入する

$$
\frac{Z_M}{Z_1} = \frac{Z_2}{Z_1} \frac{Z_3}{Z_2} \cdots \frac{Z_M}{Z_{M-1}}
$$

---

## エネルギー関数の連続パラメータ

連続パラメータ $0 \leq \alpha \leq 1$ を含むエネルギー関数を使用して、中間システムのシーケンスを構築する方法

$$
E_\alpha(z) = (1 - \alpha) E_1(z) + \alpha E_M(z)
$$

---

## 効率的なモンテカルロ法

中間比をモンテカルロ法で求める場合、各比のためにマルコフ連鎖を再起動するのではなく、単一のマルコフ連鎖を使用する方が効率的である
この場合、マルコフ連鎖は最初にシステム $p_1$ のために実行され、その後、適切なステップ数の後にシーケンス内の次の分布に移行する

---